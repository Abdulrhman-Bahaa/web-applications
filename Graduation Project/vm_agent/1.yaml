detection_rules:
  # ============================================================================
  # STATIC ANALYSIS DETECTIONS (From PE Analysis)
  # ============================================================================

  - name: 'PE_UPX_Packed'
    category: 'packing'
    field: 'file'
    action: 'create'
    pattern: '*UPX* OR *upx* OR *UPX0* OR *UPX1*'
    weight: 6
    description: 'UPX packed executable detected'

  - name: 'PE_ASPack_Packed'
    category: 'packing'
    field: 'file'
    action: 'create'
    pattern: '*aspack* OR *.aspack*'
    weight: 6
    description: 'ASPack packed executable detected'

  - name: 'PE_Themida_Packed'
    category: 'packing'
    field: 'file'
    action: 'create'
    pattern: '*Themida* OR *themida*'
    weight: 8
    description: 'Themida packed executable - heavy obfuscation'

  - name: 'PE_MPRESS_Packed'
    category: 'packing'
    field: 'file'
    action: 'create'
    pattern: '*MPRESS* OR *mpress*'
    weight: 7
    description: 'MPRESS packed executable detected'

  - name: 'PE_High_Entropy_Section'
    category: 'obfuscation'
    field: 'file'
    action: 'create'
    pattern: '*entropy>7.2* OR *entropy:7.* OR *high_entropy*'
    weight: 7
    description: 'High entropy section indicates packed/encrypted code'

  - name: 'PE_High_Entropy_Text'
    category: 'obfuscation'
    field: 'file'
    action: 'create'
    pattern: '*.text*entropy* OR *code section encrypted*'
    weight: 9
    description: '.text section with high entropy - likely packed'

  - name: 'PE_Overlay_Data'
    category: 'suspicious'
    field: 'file'
    action: 'create'
    pattern: '*overlay* OR *extra data* OR * appended data*'
    weight: 6
    description: 'Overlay data detected - possible hidden payload'

  - name: 'PE_TLS_Callback'
    category: 'anti_analysis'
    field: 'file'
    action: 'create'
    pattern: '*TLS* OR *TLS callback* OR *Thread Local Storage*'
    weight: 7
    description: 'TLS Callback detected - anti-debug technique'

  - name: 'PE_Import_Table_Missing'
    category: 'obfuscation'
    field: 'file'
    action: 'create'
    pattern: '*import table* OR *no imports* OR *import hiding*'
    weight: 8
    description: 'Import table missing or hidden - API obfuscation'

  - name: 'PE_Invalid_DOS_Header'
    category: 'tampering'
    field: 'file'
    action: 'create'
    pattern: '*DOS header* OR *MZ header*'
    weight: 5
    description: 'Invalid DOS header - possible header manipulation'

  - name: 'PE_Invalid_PE_Signature'
    category: 'tampering'
    field: 'file'
    action: 'create'
    pattern: '*PE signature* OR *invalid PE*'
    weight: 8
    description: 'Invalid PE signature - corrupted or modified binary'

  - name: 'PE_Entry_Point_Outside_Text'
    category: 'suspicious'
    field: 'file'
    action: 'create'
    pattern: '*entry point* OR *EP outside*'
    weight: 8
    description: 'Entry point outside .text section - unusual execution flow'

  - name: 'PE_Suspicious_Section_Count'
    category: 'suspicious'
    field: 'file'
    action: 'create'
    pattern: '*section count* OR *only 1 section* OR *suspicious sections*'
    weight: 5
    description: 'Suspicious number of PE sections'

  - name: 'PE_Zero_Timestamp'
    category: 'suspicious'
    field: 'file'
    action: 'create'
    pattern: '*timestamp* OR *TimeDateStamp*'
    weight: 4
    description: 'Invalid or zero timestamp - compiled time removed'

  # ============================================================================
  # API/IMPORT DETECTIONS (Behavioral indicators from static analysis)
  # ============================================================================

  - name: 'API_VirtualAlloc_Detected'
    category: 'injection'
    field: 'file'
    action: 'create'
    pattern: '*VirtualAlloc*'
    weight: 6
    description: 'Memory allocation API - possible shellcode preparation'

  - name: 'API_WriteProcessMemory_Detected'
    category: 'injection'
    field: 'file'
    action: 'create'
    pattern: '*WriteProcessMemory*'
    weight: 9
    description: 'CRITICAL: Process memory writing - code injection capability'

  - name: 'API_CreateRemoteThread_Detected'
    category: 'injection'
    field: 'file'
    action: 'create'
    pattern: '*CreateRemoteThread*'
    weight: 10
    description: 'CRITICAL: Remote thread creation - process injection'

  - name: 'API_VirtualProtect_Detected'
    category: 'injection'
    field: 'file'
    action: 'create'
    pattern: '*VirtualProtect*'
    weight: 6
    description: 'Memory protection modification - RWX memory possible'

  - name: 'API_URLDownloadToFile_Detected'
    category: 'downloader'
    field: 'file'
    action: 'create'
    pattern: '*URLDownloadToFile* OR *URLDownloadToFileA*'
    weight: 9
    description: 'CRITICAL: URL download capability - payload retrieval'

  - name: 'API_InternetOpen_Detected'
    category: 'c2'
    field: 'file'
    action: 'create'
    pattern: '*InternetOpen* OR *InternetOpenA* OR *WinINet*'
    weight: 6
    description: 'Internet connectivity API - C2 communication'

  - name: 'API_RegSetValueEx_Detected'
    category: 'persistence'
    field: 'file'
    action: 'create'
    pattern: '*RegSetValueEx* OR *RegSetValue*'
    weight: 7
    description: 'Registry modification API - persistence mechanism'

  - name: 'API_WinExec_Detected'
    category: 'execution'
    field: 'file'
    action: 'create'
    pattern: '*WinExec*'
    weight: 7
    description: 'Command execution API - arbitrary program execution'

  - name: 'API_ShellExecute_Detected'
    category: 'execution'
    field: 'file'
    action: 'create'
    pattern: '*ShellExecute* OR *ShellExecuteA* OR *ShellExecuteW*'
    weight: 7
    description: 'Shell execution API - program spawning capability'

  - name: 'API_LoadLibrary_Dynamic'
    category: 'evasion'
    field: 'file'
    action: 'create'
    pattern: '*LoadLibrary* OR *GetProcAddress*'
    weight: 5
    description: 'Dynamic API loading - runtime import resolution'

  - name: 'API_Multiple_Suspicious'
    category: 'malware_toolkit'
    field: 'file'
    action: 'create'
    pattern: '*VirtualAlloc* AND *WriteProcessMemory* AND *CreateRemoteThread*'
    weight: 10
    description: 'CRITICAL: Full injection toolkit detected'

  # ============================================================================
  # URL/NETWORK INDICATORS
  # ============================================================================

  - name: 'Hardcoded_URL_HTTP'
    category: 'c2'
    field: 'file'
    action: 'create'
    pattern: '*http://* OR *https://*'
    weight: 6
    description: 'Hardcoded HTTP URL in binary - possible C2'

  - name: 'Hardcoded_IP_Address'
    category: 'c2'
    field: 'file'
    action: 'create'
    pattern: '*[0-9]*.[0-9]*.[0-9]*.[0-9]*:*/ OR */api/* OR */upload*'
    weight: 7
    description: 'Hardcoded IP address or API endpoint'

  - name: 'URL_Discord_Webhook'
    category: 'c2'
    field: 'file'
    action: 'create'
    pattern: '*discord.com/api/webhooks* OR *discordapp.com/api/webhooks*'
    weight: 9
    description: 'Discord webhook URL - data exfiltration C2'

  - name: 'URL_Pastebin_Raw'
    category: 'loader'
    field: 'file'
    action: 'create'
    pattern: '*pastebin.com/raw/* OR *paste.ee* OR *hastebin.com*'
    weight: 8
    description: 'Pastebin/raw URL - stage 2 payload hosting'

  - name: 'URL_Telegram_Bot'
    category: 'c2'
    field: 'file'
    action: 'create'
    pattern: '*api.telegram.org/bot*'
    weight: 9
    description: 'Telegram bot API - C2 communication channel'

  # ============================================================================
  # VIRUSTOTAL DETECTIONS
  # ============================================================================

  - name: 'VT_Malicious_Detections_High'
    category: 'reputation'
    field: 'file'
    action: 'create'
    pattern: '*malicious>10* OR *detection>10*'
    weight: 10
    description: 'CRITICAL: High VirusTotal detection rate'

  - name: 'VT_Malicious_Detections_Medium'
    category: 'reputation'
    field: 'file'
    action: 'create'
    pattern: '*malicious>5* OR *detection>5*'
    weight: 8
    description: 'Suspicious: Medium VirusTotal detection rate'

  - name: 'VT_Suspicious_Detections'
    category: 'reputation'
    field: 'file'
    action: 'create'
    pattern: '*suspicious>3* OR *malicious>0*'
    weight: 6
    description: 'Some AV engines detect as malicious/suspicious'

  # ============================================================================
  # SIGMA-STYLE ADVANCED RULES
  # ============================================================================

  - title: Suspicious Executable Masquerading as Domain Name
    id: 7e9c1a44-1b8f-4b7e-9a5c-9a0f3c2e9f01
    status: experimental
    description: >
      Detects execution of suspicious Windows executables using domain-like
      filenames (e.g. *.com.exe) that exhibit post-execution network activity.
    author: analyst
    date: 2026-02-10
    references:
      - internal-malware-analysis
    tags:
      - attack.execution
      - attack.defense_evasion
      - attack.command_and_control
      - malware.suspected_loader
    logsource:
      product: windows
      category: process_creation
    detection:
      filename_suspicious:
        Image|endswith:
          - ".com.exe"
          - ".net.exe"
          - ".org.exe"
      execution_path:
        Image|contains:
          - "\\Users\\"
          - "\\AppData\\"
          - "\\Temp\\"
          - "\\Downloads\\"
      suspicious_parent:
        ParentImage|endswith:
          - "\\explorer.exe"
          - "\\outlook.exe"
          - "\\chrome.exe"
          - "\\msedge.exe"
      optional_hash_match:
        Hashes|contains:
          - "SHA256=a9b670ff357cbb942a795c8524999072cd9466486b9c28b5b0d809b01547293b"
      condition: filename_suspicious and execution_path and suspicious_parent
    falsepositives:
      - Rare legitimate installers using misleading filenames
      - User-renamed executables
    level: high

  # ============================================================================
  # SHEETRAT BEHAVIOR DETECTIONS (New Rules Added)
  # ============================================================================

  - name: 'EXE_In_Windows_Subfolder'
    category: 'persistence'
    field: 'file'
    action: 'create'
    pattern: '*/Windows/Sub/*.exe OR */Windows/Temp/*.exe OR */Windows/Tasks/*.exe OR */Windows/SysWOW64/Sub/*.exe'
    weight: 9
    description: 'CRITICAL: Executable in Windows subfolder - SYSTEM abuse'

  - name: 'Masquerading_RuntimeBroker'
    category: 'evasion'
    field: 'process'
    action: 'create'
    pattern: '*RuntimeBroker* OR *RuntimeBroker.exe*'
    weight: 9
    description: 'Malware masquerading as RuntimeBroker.exe system process'

  - name: 'Obfuscated_Schtasks_Command'
    category: 'evasion'
    field: 'process'
    action: 'create'
    pattern: '*SchTaSKs* OR *CrEAte* OR *OnLoGoN* OR */F* OR */sc* OR */rl* OR */tn* OR */tr*'
    weight: 8
    description: 'Case-obfuscated schtasks command - evasion technique'

  - name: 'Schtasks_Persistence_Generic'
    category: 'persistence'
    field: 'process'
    action: 'create'
    pattern: '*schtasks* OR *SCHTASKS* OR *SchTaSKs* OR *SchTasks*'
    weight: 8
    description: 'Scheduled task creation - persistence mechanism'

  - name: 'System_Directory_Abuse'
    category: 'persistence'
    field: 'file'
    action: 'create'
    pattern: '*/Windows/*.exe OR */Windows/System32/*.exe OR */Windows/SysWOW64/*.exe'
    weight: 10
    description: 'CRITICAL: Executable in Windows system directory'

  - name: 'Hidden_Directory_Created'
    category: 'evasion'
    field: 'file'
    action: 'create'
    pattern: '*/Sub OR */Hidden OR */.hidden OR */$Recycle.Bin*'
    weight: 6
    description: 'Hidden or suspicious directory created'

  - name: 'Startup_Registry_RuntimeBroker'
    category: 'persistence'
    field: 'registry'
    action: 'create'
    pattern: '*/Run/RuntimeBroker* OR */Run/RuntimeBroker.exe*'
    weight: 10
    description: 'CRITICAL: RuntimeBroker persistence in Run key - SheetRAT IOC'

  - name: 'Command_Obfuscation_MixedCase'
    category: 'evasion'
    field: 'process'
    action: 'create'
    pattern: '*CMD* OR *CmD* OR *cMd* OR *cmD* OR *CMD /C* OR *cmd /c*'
    weight: 7
    description: 'Mixed-case CMD execution - obfuscation technique'

  - name: 'High_Privilege_Schtasks'
    category: 'persistence'
    field: 'process'
    action: 'create'
    pattern: '*/rl*Highest* OR */rl*HIGHEST* OR *HighEst* OR */sc*OnLogon* OR */sc*ONLOGON* OR *OnLoGoN*'
    weight: 9
    description: 'High privilege scheduled task with logon trigger'

  - name: 'AppData_Sub_Directory'
    category: 'persistence'
    field: 'file'
    action: 'create'
    pattern: '*/AppData/Roaming/Sub* OR */AppData/Local/Sub* OR */Roaming/Sub/*'
    weight: 7
    description: 'Suspicious Sub directory in AppData'

  # ============================================================================
  # SHEETRAT SPECIFIC DETECTION RULES
  # ============================================================================

  - name: 'SheetRAT_Imphash_Detected'
    category: 'rat'
    field: 'file'
    action: 'create'
    pattern: 'imphash:f34d5f2d4577ed6d9ceec516c1f5a744'
    weight: 10
    description: 'CRITICAL: SheetRAT/NONEUCLID RAT imphash detected - Known RAT family'

  - name: 'SheetRAT_NET_Executable'
    category: 'rat'
    field: 'file'
    action: 'create'
    pattern: '*.exe AND (TrID:.NET OR TrID:CIL) AND size:678912'
    weight: 8
    description: 'Suspicious .NET executable matching SheetRAT profile'

  - name: 'SheetRAT_Discord_C2_Communication'
    category: 'c2'
    field: 'network'
    action: 'create'
    pattern: '*discord.com/api/webhooks* OR *discordapp.com/api/webhooks*'
    weight: 9
    description: 'Discord webhook C2 communication - SheetRAT behavior'

  - name: 'SheetRAT_Keylogger_Indicator'
    category: 'infostealer'
    field: 'file'
    action: 'create'
    pattern: '*/Temp/keys.log OR */AppData/keys.txt OR */logs/keystrokes.txt'
    weight: 8
    description: 'Keylogger log file created - SheetRAT data theft'

  - name: 'SheetRAT_Rootkit_Behavior'
    category: 'evasion'
    field: 'process'
    action: 'create'
    pattern: '*process:hollowing* OR *process:injection* OR *ntdll*unhook*'
    weight: 10
    description: 'Rootkit process injection behavior detected'

  - name: 'SheetRAT_UAC_Bypass'
    category: 'evasion'
    field: 'process'
    action: 'create'
    pattern: '*fodhelper.exe* OR *computerdefaults.exe* OR *slui.exe*'
    weight: 9
    description: 'UAC bypass technique used by SheetRAT'

  - name: 'SheetRAT_Anti_Debug'
    category: 'evasion'
    field: 'process'
    action: 'create'
    pattern: '*CheckRemoteDebuggerPresent* OR *IsDebuggerPresent* OR *NtGlobalFlag*'
    weight: 7
    description: 'Anti-debugging technique detected'

  - name: 'SheetRAT_Persistence_Task'
    category: 'persistence'
    field: 'process'
    action: 'create'
    pattern: '*schtasks* OR *SchTaSKs* OR *SCHTASKS* OR */create* OR */CrEAte* OR */tn* OR */TN*'
    weight: 8
    description: 'Scheduled task persistence - SheetRAT pattern'

  - name: 'SheetRAT_Clipboard_Stealer'
    category: 'infostealer'
    field: 'process'
    action: 'create'
    pattern: '*GetClipboardData* OR *OpenClipboard* AND (btc OR xmr OR eth OR wallet)'
    weight: 7
    description: 'Clipboard hijacking for crypto theft - SheetRAT behavior'

  - name: 'SheetRAT_System_Recon'
    category: 'reconnaissance'
    field: 'process'
    action: 'create'
    pattern: '*systeminfo* OR *whoami* OR *net config* OR *ipconfig* OR *tasklist*'
    weight: 6
    description: 'System reconnaissance commands - SheetRAT profiling'

  - name: 'SheetRAT_Browser_Credential_Theft'
    category: 'credential_theft'
    field: 'file'
    action: 'read'
    pattern: '*/Login Data* OR */Cookies* OR */History* AND (Chrome OR Firefox OR Edge)'
    weight: 9
    description: 'Browser credential database accessed - SheetRAT infostealer'

  - name: 'SheetRAT_Screenshot_Capture'
    category: 'infostealer'
    field: 'file'
    action: 'create'
    pattern: '*.png AND (*/Temp/ OR */AppData/) AND (screen OR screenshot OR capture)'
    weight: 7
    description: 'Screenshot capture file created - SheetRAT surveillance'

  # ============================================================================
  # EASY MALWARE DETECTIONS (Score: 7)
  # ============================================================================
  - name: 'Folder_In_System32'
    category: 'persistence'
    field: 'file'
    action: 'create'
    pattern: '*/Windows/System32/MyMalwareFolder*'
    weight: 7
    description: 'Suspicious folder created in System32'

  # ============================================================================
  # MEDIUM MALWARE DETECTIONS (Score: 43)
  # ============================================================================
  - name: 'Registry_Run_Key'
    category: 'persistence'
    field: 'registry'
    action: 'create'
    pattern: '*/Software/Microsoft/Windows/CurrentVersion/Run/*'
    weight: 10
    description: 'Run key persistence detected'

  - name: 'EXE_In_AppData'
    category: 'persistence'
    field: 'file'
    action: 'create'
    pattern: '*/AppData/Roaming/chrome_update.exe'
    weight: 9
    description: 'Executable dropped in AppData'

  - name: 'Document_Created_By_Malware'
    category: 'infostealer'
    field: 'file'
    action: 'create'
    pattern: '*/Documents/salary.xlsx OR */Documents/passwords.docx OR */Documents/secret.docx'
    weight: 6
    description: 'Sensitive document created by malware'

  - name: 'Notepad_Process_Created'
    category: 'execution'
    field: 'process'
    action: 'create'
    pattern: '*notepad*'
    weight: 6
    description: 'Notepad process spawned by malware'

  - name: 'Chrome_Update_Process'
    category: 'evasion'
    field: 'process'
    action: 'create'
    pattern: '*chrome_update*'
    weight: 6
    description: 'Suspicious chrome update process running'

  # ============================================================================
  # HARD MALWARE DETECTIONS (Score: 100+)
  # ============================================================================
  - name: 'Winlogon_Shell_Modified'
    category: 'persistence'
    field: 'registry'
    action: 'modify'
    pattern: '*/Winlogon/Shell'
    weight: 10
    description: 'CRITICAL: Winlogon shell modified'

  - name: 'Service_Installed'
    category: 'persistence'
    field: 'registry'
    action: 'create'
    pattern: '*/System/CurrentControlSet/Services/WinDefender'
    weight: 9
    description: 'Fake Windows Defender service installed'

  - name: 'Run_Key_Added'
    category: 'persistence'
    field: 'registry'
    action: 'create'
    pattern: '*/Run/SystemUpdate'
    weight: 10
    description: 'SystemUpdate run key added'

  - name: 'Defender_RealTime_Disabled'
    category: 'evasion'
    field: 'registry'
    action: 'modify'
    pattern: '*/Windows Defender/Real-Time Protection/DisableRealtimeMonitoring'
    weight: 9
    description: 'Windows Defender real-time protection disabled'

  - name: 'Defender_AntiSpyware_Disabled'
    category: 'evasion'
    field: 'registry'
    action: 'create'
    pattern: '*/Windows Defender/DisableAntiSpyware'
    weight: 9
    description: 'Windows Defender anti-spyware disabled'

  - name: 'TaskManager_Disabled'
    category: 'evasion'
    field: 'registry'
    action: 'create'
    pattern: '*/Policies/System/DisableTaskMgr'
    weight: 8
    description: 'Task Manager disabled'

  - name: 'Malware_Dropped_System32'
    category: 'infection'
    field: 'file'
    action: 'create'
    pattern: '*/Windows/System32/svchost.exe'
    weight: 10
    description: 'CRITICAL: Malware dropped in System32'

  - name: 'Mimikatz_DLL_Dropped'
    category: 'credential_theft'
    field: 'file'
    action: 'create'
    pattern: '*/Temp/mimilib.dll'
    weight: 10
    description: 'Mimikatz credential dumping tool detected'

  - name: 'PowerShell_Script_Dropped'
    category: 'dropper'
    field: 'file'
    action: 'create'
    pattern: '*/Temp/stage2.ps1'
    weight: 6
    description: 'PowerShell script dropped'

  - name: 'LSASS_Modified'
    category: 'infection'
    field: 'file'
    action: 'modify'
    pattern: '*/System32/lsass.exe'
    weight: 10
    description: 'CRITICAL: LSASS modified - credential dumping'

  - name: 'Outlook_Data_Accessed'
    category: 'infostealer'
    field: 'file'
    action: 'read'
    pattern: '*/Outlook/Outlook.pst'
    weight: 8
    description: 'Outlook PST file accessed - email theft'

  - name: 'Encoded_PowerShell_Execution'
    category: 'execution'
    field: 'process'
    action: 'create'
    pattern: '*powershell* -enc*'
    weight: 8
    description: 'Encoded PowerShell command execution'

  - name: 'PowerShell_Download_Cradle'
    category: 'execution'
    field: 'process'
    action: 'create'
    pattern: '*powershell*DownloadString*'
    weight: 8
    description: 'PowerShell downloading external content'

  - name: 'Rundll32_DLL_Injection'
    category: 'execution'
    field: 'process'
    action: 'create'
    pattern: '*rundll32*mimilib.dll*'
    weight: 9
    description: 'Rundll32 executing DLL injection'

  - name: 'Shadow_Copies_Deleted'
    category: 'ransomware'
    field: 'process'
    action: 'create'
    pattern: '*vssadmin*delete shadows*'
    weight: 10
    description: 'CRITICAL: Ransomware deleting shadow copies'

  - name: 'Defender_Process_Killed'
    category: 'evasion'
    field: 'process'
    action: 'delete'
    pattern: '*MsMpEng*'
    weight: 9
    description: 'Windows Defender process terminated'

  - name: 'CMD_Executing_Vssadmin'
    category: 'ransomware'
    field: 'process'
    action: 'create'
    pattern: '*cmd*vssadmin*'
    weight: 9
    description: 'Command prompt executing vssadmin (ransomware)'

  - name: 'Office_Spawning_System_Process'
    category: 'execution'
    field: 'process'
    action: 'create'
    pattern: '*OUTLOOK*svchost* OR *WINWORD*powershell* OR *EXCEL*cmd*'
    weight: 10
    description: 'CRITICAL: Office application spawning system process'

  - name: 'CMD_Hidden_Process'
    category: 'execution'
    field: 'process'
    action: 'create'
    pattern: '*cmd*'
    weight: 6
    description: 'Command prompt spawned'

  - name: 'PowerShell_Hidden_Process'
    category: 'execution'
    field: 'process'
    action: 'create'
    pattern: '*powershell*'
    weight: 6
    description: 'PowerShell spawned with hidden window'

  - name: 'Calc_Process_Started'
    category: 'execution'
    field: 'process'
    action: 'create'
    pattern: '*calc*'
    weight: 6
    description: 'Calculator spawned (demo process)'

  # ============================================================================
  # GENERIC MALWARE BEHAVIORS (No specific names)
  # ============================================================================

  # --- PERSISTENCE BEHAVIORS ---
  - name: 'New_Run_Key'
    category: 'persistence'
    field: 'registry'
    action: 'create'
    pattern: '*/Run/*'
    weight: 8
    description: 'New startup registry key added'

  - name: 'Suspicious_Registry_Persistence'
    category: 'persistence'
    field: 'registry'
    action: 'create'
    pattern: '*/RunOnce/* OR */Winlogon/Shell OR */Winlogon/Userinit'
    weight: 10
    description: 'Persistence mechanism in critical location'

  - name: 'New_Service_Installed'
    category: 'persistence'
    field: 'registry'
    action: 'create'
    pattern: '*/Services/*'
    weight: 7
    description: 'New system service installed'

  # --- FILE SYSTEM BEHAVIORS ---
  - name: 'EXE_In_User_Profile'
    category: 'persistence'
    field: 'file'
    action: 'create'
    pattern: '*/AppData/*.exe OR */AppData/Local/*.exe OR */AppData/Roaming/*.exe'
    weight: 7
    description: 'Executable dropped in user profile'

  - name: 'Suspicious_Documents_Created'
    category: 'infostealer'
    field: 'file'
    action: 'create'
    pattern: '*/Documents/*.xlsx OR */Documents/*.docx OR */Documents/*.pdf OR */Documents/*.txt'
    weight: 5
    description: 'Documents created in user folder'

  - name: 'Files_In_Temp'
    category: 'dropper'
    field: 'file'
    action: 'create'
    pattern: '*/Temp/*.exe OR */Temp/*.dll OR */Temp/*.ps1 OR */Temp/*.bat'
    weight: 6
    description: 'Executable files created in temp directory'

  - name: 'Hidden_File_Created'
    category: 'evasion'
    field: 'file'
    action: 'create'
    pattern: '*/*'
    weight: 4
    description: 'Hidden file created'

  # --- PROCESS BEHAVIORS ---
  - name: 'CMD_Spawned'
    category: 'execution'
    field: 'process'
    action: 'create'
    pattern: '*cmd.exe* OR *cmd*whoami* OR *cmd*net user*'
    weight: 5
    description: 'Command prompt spawned'

  - name: 'PowerShell_Spawned'
    category: 'execution'
    field: 'process'
    action: 'create'
    pattern: '*powershell.exe* OR *pwsh.exe*'
    weight: 6
    description: 'PowerShell spawned'

  - name: 'Encoded_PowerShell'
    category: 'execution'
    field: 'process'
    action: 'create'
    pattern: '*-enc* OR *-EncodedCommand* OR *-e *'
    weight: 9
    description: 'Encoded PowerShell command detected'

  - name: 'Network_Connection_From_New_Process'
    category: 'c2'
    field: 'network'
    action: 'create'
    pattern: '*ESTABLISHED*'
    weight: 5
    description: 'Network connection established'

  - name: 'Rundll32_Execution'
    category: 'execution'
    field: 'process'
    action: 'create'
    pattern: '*rundll32.exe*'
    weight: 7
    description: 'Rundll32 executing (possible DLL injection)'

  - name: 'WMIC_Execution'
    category: 'execution'
    field: 'process'
    action: 'create'
    pattern: '*wmic.exe* OR *wmic*process* OR *wmic* OR *WmiPrvSE.exe* OR *wmiprvse*'
    weight: 6
    description: 'WMIC or WMI Provider spawned (common in malware)'

  - name: 'CertUtil_Execution'
    category: 'execution'
    field: 'process'
    action: 'create'
    pattern: '*certutil.exe*'
    weight: 7
    description: 'CertUtil spawned (possible download/decode)'

  # --- DEFENSE EVASION ---
  - name: 'Defender_Disabled'
    category: 'evasion'
    field: 'registry'
    action: 'modify'
    pattern: '*DisableAntiSpyware* OR *DisableRealtimeMonitoring*'
    weight: 10
    description: 'Windows Defender disabled'

  - name: 'TaskManager_Disabled'
    category: 'evasion'
    field: 'registry'
    action: 'create'
    pattern: '*DisableTaskMgr*'
    weight: 8
    description: 'Task Manager disabled'

  # --- RANSOMWARE INDICATORS ---
  - name: 'Mass_File_Modification'
    category: 'ransomware'
    field: 'file'
    action: 'modify'
    pattern: '*.encrypted OR *.locked OR *.crypto'
    weight: 10
    description: 'Files with ransomware extensions'

  - name: 'Shadow_Copy_Deletion'
    category: 'ransomware'
    field: 'process'
    action: 'create'
    pattern: '*vssadmin*delete* OR *wmic*shadowcopy*delete*'
    weight: 10
    description: 'Shadow copies deleted (ransomware behavior)'

  # --- DATA THEFT ---
  - name: 'Browser_Data_Accessed'
    category: 'infostealer'
    field: 'file'
    action: 'read'
    pattern: '*/Chrome/User Data/* OR */Firefox/Profiles/* OR */Edge/User Data/*'
    weight: 7
    description: 'Browser data accessed'

  - name: 'Credential_Files_Accessed'
    category: 'credential_theft'
    field: 'file'
    action: 'read'
    pattern: '*/LSA* OR */SAM* OR */SECURITY* OR */NTDS.dit*'
    weight: 10
    description: 'Credential storage files accessed'

  # --- BLOCKED ATTEMPTS (Failed actions) ---
  - name: 'Registry_Modify_Attempt'
    field: 'registry'
    action: 'attempt'
    pattern: '*/Windows Defender/* OR */Policies/System/*'
    weight: 5
    description: 'Attempted to modify system registry (may have failed)'

  - name: 'File_Access_Attempt'
    field: 'file'
    action: 'attempt'
    pattern: '*/System32/* OR */SysWOW64/*'
    weight: 4
    description: 'Attempted to access system files'

  - name: 'Process_Start_Failed'
    field: 'process'
    action: 'attempt'
    pattern: '*vssadmin* OR *bcdedit* OR *wevtutil*'
    weight: 6
    description: 'Attempted to start system process (failed or blocked)'

  # ============================================================================
  # NEW RULES FOR MALWARE 3 (Added to detect missing behaviors)
  # ============================================================================

  # --- NEW FILE RULES ---
  - name: 'PowerShell_Dropped_AppData'
    category: 'dropper'
    field: 'file'
    action: 'create'
    pattern: '*/AppData/*.ps1 OR */AppData/Local/*.ps1 OR */AppData/Roaming/*.ps1'
    weight: 6
    description: 'PowerShell script dropped in AppData'

  - name: 'DLL_Dropped_AppData'
    category: 'dropper'
    field: 'file'
    action: 'create'
    pattern: '*/AppData/*.dll OR */AppData/Local/*.dll OR */AppData/Roaming/*.dll OR */AppData/Roaming/Microsoft/Windows/*.dll OR */AppData/Local/Microsoft/Windows/*.dll'
    weight: 7
    description: 'DLL dropped in user profile (possible sideloading)'

  - name: 'Batch_Dropped_Startup'
    category: 'persistence'
    field: 'file'
    action: 'create'
    pattern: '*/Startup/*.bat OR */Startup/*.cmd'
    weight: 9
    description: 'Batch script in Startup folder (persistence)'

  - name: 'EXE_In_AppData_Subfolder'
    category: 'persistence'
    field: 'file'
    action: 'create'
    pattern: '*/AppData/Roaming/Microsoft/Windows/*.exe OR */AppData/Local/Microsoft/Windows/*.exe'
    weight: 8
    description: 'Executable in disguised Windows subfolder'

  - name: 'Flag_File_Created'
    category: 'evasion'
    field: 'file'
    action: 'create'
    pattern: '*/Temp/done.flag OR */Temp/*.flag OR */Temp/*.txt'
    weight: 3
    description: 'Marker/flag file created by malware'

  # --- NEW PROCESS RULES ---
  - name: 'WMIC_Process_Enumeration'
    category: 'reconnaissance'
    field: 'process'
    action: 'create'
    pattern: '*wmic*process*list* OR *wmic*'
    weight: 6
    description: 'WMIC used for system enumeration'

  - name: 'PowerShell_Network_Download'
    category: 'c2'
    field: 'process'
    action: 'create'
    pattern: '*powershell*WebClient* OR *powershell*DownloadString* OR *powershell*Net.WebClient*'
    weight: 9
    description: 'PowerShell downloading content from network'

  - name: 'VSSAdmin_List_Attempt'
    category: 'ransomware'
    field: 'process'
    action: 'create'
    pattern: '*vssadmin*list*shadows* OR *vssadmin*'
    weight: 7
    description: 'VSSAdmin checking shadow copies (ransomware prep)'

  # --- NEW REGISTRY RULES ---
  - name: 'Defender_Notifications_Disabled'
    category: 'evasion'
    field: 'registry'
    action: 'create'
    pattern: '*/Windows.Defender.SecurityCenter* OR */Notifications/Settings/Windows.Defender*'
    weight: 6
    description: 'Windows Defender notifications disabled'

  - name: 'Winlogon_Shell_Attempt'
    category: 'persistence'
    field: 'registry'
    action: 'attempt'
    pattern: '*/Winlogon/Shell'
    weight: 8
    description: 'Attempted Winlogon shell modification'

  # ============================================================================
  # WMIPRVSE BEHAVIOR DETECTION (Compatible with Current Engine)
  # ============================================================================

  - name: 'WMIPRVSE_From_AppData'
    category: 'masquerading'
    field: 'process'
    action: 'create'
    pattern: '*wmiprvse*AppData*'
    weight: 9
    description: 'CRITICAL: WmiPrvSE.exe running from AppData'

  - name: 'WMIPRVSE_From_Temp'
    category: 'masquerading'
    field: 'process'
    action: 'create'
    pattern: '*wmiprvse*Temp*'
    weight: 9
    description: 'CRITICAL: WmiPrvSE.exe running from Temp'

  - name: 'WMIPRVSE_From_Downloads'
    category: 'masquerading'
    field: 'process'
    action: 'create'
    pattern: '*wmiprvse*Downloads*'
    weight: 9
    description: 'CRITICAL: WmiPrvSE.exe running from Downloads'

  - name: 'WMIPRVSE_With_Arguments'
    category: 'execution'
    field: 'process'
    action: 'create'
    pattern: '*wmiprvse*-*'
    weight: 6
    description: 'WmiPrvSE.exe executed with command-line arguments'

  - name: 'WMIPRVSE_Execution_Test'
    category: 'test_rule'
    field: 'process'
    action: 'create'
    pattern: '*wmiprvse*'
    weight: 2
    description: 'Test rule to confirm ETW process detection'