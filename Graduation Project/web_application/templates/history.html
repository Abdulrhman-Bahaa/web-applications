{% extends "base.html" %}

{% block title %}History - MalwareScope{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3">Analysis History</h1>
</div>

<div class="card mb-4">
    <div class="card-header">
        <form class="d-flex gap-2" method="post" action="/search">
            <input type="text" class="form-control" name="search" placeholder="Search by filename or hash..." value="">
            <select class="form-select" name="status" style="max-width: 150px;">
                <option value="">All Status</option>
                <option value="completed" {% if request.args.get('status')=='completed' %}selected{% endif %}>Completed
                </option>
                <option value="pending" {% if request.args.get('status')=='pending' %}selected{% endif %}>Pending
                </option>
                <option value="failed" {% if request.args.get('status')=='failed' %}selected{% endif %}>Failed</option>
            </select>
            <button type="submit" class="btn btn-primary">Search</button>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-header">Recent samples</div>
    <div class="card-body">
        {% if samples %}
        <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>File Name</th>
                        <th>File Size</th>
                        <th>File Type</th>
                        <th>Hash (SHA256)</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in samples %}
                    <tr>
                        <td>{{ s.id }}</td>
                        <td class="text-truncate" style="max-width: 200px;">{{ s.file_name }}</td>
                        <td>{{ s.file_size }} B</td>
                        <td>{{ s.file_type or 'unknown' }}</td>
                        <td class="hash text-truncate" style="max-width: 200px;">{{ s.hash_sha256 }}</td>
                        <td>
                            {% if s.status == 'completed' %}
                            <span class="badge bg-success">Completed</span>
                            {% elif s.status == 'pending' %}
                            <span class="badge bg-warning">Pending</span>
                            {% elif s.status == 'failed' %}
                            <span class="badge bg-danger">Failed</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ s.status }}</span>
                            {% endif %}
                        </td>
                        <td>{{ s.created_at or 'N/A' }}</td>
                        <td class="text-end">
                            <a class="btn btn-sm btn-outline-primary" href="/analysis/{{ s.id }}">View</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="mb-0 text-muted">No Analysis history available yet. Upload a sample to get started.</p>
        {% endif %}
    </div>
</div>

<div class="mt-4">
    <nav aria-label="Page navigation">
        <ul class="pagination">
            <li class="page-item disabled"><a class="page-link" href="#">Previous</a></li>
            <li class="page-item active"><a class="page-link" href="#">1</a></li>
            <li class="page-item"><a class="page-link" href="#">2</a></li>
            <li class="page-item"><a class="page-link" href="#">3</a></li>
            <li class="page-item"><a class="page-link" href="#">Next</a></li>
        </ul>
    </nav>
</div>

{% endblock %}

{% block extra_js %}
<script>
    function deletes(sId) {
        if (confirm('Are you sure you want to delete this s?')) {
            // Make DELETE request to backend
            fetch(`/s/${sId}`, {
                method: 'DELETE'
            })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    }
                })
                .catch(error => console.error('Error:', error));
        }
    }
</script>
{% endblock %}